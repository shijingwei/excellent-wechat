var express = require('express');
var AV = require('leanengine');
var xml2js = require('xml2js');
var weixin = require('cloud/weixin.js');
var account = require('cloud/weixin_interface/account.js');
var utils = require('express/node_modules/connect/lib/utils');

// 解析微信的 xml 数据
var xmlBodyParser = function (req, res, next) {
  if (req._body) return next();
  req.body = req.body || {};

  // ignore GET
  if ('GET' == req.method || 'HEAD' == req.method) return next();

  // check Content-Type
  if ('text/xml' != utils.mime(req)) return next();

  // flag as parsed
  req._body = true;

  // parse
  var buf = '';
  req.setEncoding('utf8');
  req.on('data', function(chunk){ buf += chunk });
  req.on('end', function(){
    xml2js.parseString(buf, function(err, json) {
      if (err) {
          err.status = 400;
          next(err);
      } else {
          req.body = json;
          next();
      }
    });
  });
};

var app = express();

// App 全局配置
app.set('views','cloud/views');   // 设置模板目录
app.set('view engine', 'ejs');    // 设置 template 引擎
app.use(express.bodyParser());    // 读取请求 body 的中间件
app.use(xmlBodyParser);

// 加载 cookieSession 以支持 AV.User 的会话状态
app.use(AV.Cloud.CookieSession({maxAge: 3600000}));

app.get('/login', function(req, res) {
  // 渲染登录页面
  res.render('login');
});
// 点击登录页面的提交将出发下列函数
app.post('/login', function(req, res) {
  AV.User.logIn(req.body.username, req.body.password).then(function(user) {
    //登录成功，AV.Cloud.CookieSession 会自动将登录用户信息存储到 cookie
    //跳转到profile页面。
    console.log('signin successfully: %j', user);
    res.redirect('/profile');
  },function(error) {
    //登录失败，跳转到登录页面
    res.redirect('/login');
  });
});
//查看用户profile信息
app.get('/profile', function(req, res) {
  // 判断用户是否已经登录
  if (req.AV.user) {
    // 如果已经登录，发送当前登录用户信息。
    res.send(req.AV.user);
  } else {
    // 没有登录，跳转到登录页面。
    res.redirect('/login');
  }
});

//调用此url来登出帐号
app.get('/logout', function(req, res) {
  // AV.Cloud.CookieSession 将自动清除登录 cookie 信息
  AV.User.logOut();
  res.redirect('/profile');
});

// 使用 Express 路由 API 服务 /hello 的 HTTP GET 请求
app.get('/hello', function(req, res) {
  res.render('hello', { message: 'Congrats, you just set up your app!' });
});

app.get('/weixin', function(req, res) {
  console.log('weixin req:', req.query);
  weixin.exec(req.query, function(err, data) {
    if (err) {
      return res.send(err.code || 500, err.message);
    }
    return res.send(data);
  });
})

app.post('/weixin', function(req, res) {
  console.log('weixin req:', req.body);
  weixin.exec(req.body, function(err, data) {
    if (err) {
      return res.send(err.code || 500, err.message);
    }
    var builder = new xml2js.Builder();
    var xml = builder.buildObject(data);
    console.log('res:', data)
    res.set('Content-Type', 'text/xml');
    return res.send(xml);
  });
})

//注册用户
app.get('/register',function(req, res) {res.render('weixin/register');});
app.post('/register',account.register);

// 最后，必须有这行代码来使 express 响应 HTTP 请求
app.listen();

NJfuR8ax5JrcSC-OKCgwurZtVvRwSRbVlDimAtquXMIkoUvDCkU-tMtPLr_Ci79IDjj8nd63eRE5hA5BQUck9T8z9H5M7N29Dlf0eU2mk-YMHPdACAUPX

"oyJY1twkETxcfra09aU1KpYdGuwo",1
"oyJY1t8lnAjTNzljNPw1RQoAYZp4",1
"oyJY1t1NVyc_SNciZDUyaDZufnFw",1
"oyJY1t_hnKGhXyb3BqWx1PMh8ZjQ", 1
"oyJY1tzBKxx6DiKM68rlOyvgjTy0", 1
"oyJY1t3-7RvFtYf5517nlnikkP6w", 1
"oyJY1tw4W_aRAZO3ju56x1935e6E", 1
"oyJY1t99YwHAGH1ABFe4yC25npOw", shi
"oyJY1t08YRwdUPovk4ZHMGsE-DPE",
"oyJY1t75JtD6ErgwaRxREc-UyvAw",
"oyJY1t8IQoiy1wOQWp4dB_lPa2CQ",
"oyJY1t-yNKoOdNN_T5-hrMBiD-LI",
"oyJY1t29YeGq8tjejc2jcEp8SzPg",
"oyJY1t7__BQHY6BRy7Zq4HAEIENU",
"oyJY1t_fBzEdMPy6qQBL5MtLXvkA",
"oyJY1t9IYYW5YwWS2eetd4IXr2UU",
"oyJY1t6D7naIz4OobeFNN52ov-BA",
"oyJY1t2DHxT-S1v3FO5S9ZOu9i6k",
"oyJY1tyYmP7KsfU02hhSVC-UOKd8",
"oyJY1tz4k3yTbjnBmmj6xXTFaqts",
"oyJY1t6JZia6gL_UB6VkNCn_mn9E",
"oyJY1t05E-fmI_HfHHOsB-vSw03c",
"oyJY1t7CsNmR05qX_G87rbEICbpQ",
"oyJY1tyXAA5SUMRH_1xjiRuX9GiI",
"oyJY1t1ESSFoFhO1_coBZe-DWigY",
"oyJY1t8HWMBaLvhTisrNtDLwpbaA",
"oyJY1twtjvYYdXYR331M_4BoDqn0",
"oyJY1t6KDEulbGqzYMIv_X_bgUUs",
"oyJY1twZW70hsWOI4cfSilEmQv44",
"oyJY1t7ypzQbOltyiuFJ_teNpRiY",
"oyJY1tzUre0n-JAfkVFwOY5v6M0o",
"oyJY1t4jqiHnb0dTTPcHSVRgwnpc",
"oyJY1twmo-YRFUJ4FOxYGH5SY5p4",
"oyJY1t2czky3-T0WMavScZty7PfQ",
"oyJY1t05nTjpzbk-oWWRScmGB5Uw",
"oyJY1t0rfOztkZ3rXY3nDHgwxZ2w",
"oyJY1twmPg8NBv2JNRvlz-Z2NCZQ",
"oyJY1t8yuIP9nwEmtOZLDnj7IjKA",
"oyJY1t35mjae7u_EIcaZVYMxvKac",
"oyJY1t1Km5kb_Y71HLeaQmt_vgSk",
"oyJY1t9AvmHc3aUad3bN3vUCkzpc"
